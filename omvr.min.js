function OMVR(){function e(){t.aspect=window.innerWidth/window.innerHeight,t.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight),a.setSize(window.innerWidth,window.innerHeight)}var t,i,n,a,o={Roll:0,Pitch:0,Yaw:0},r={Roll:0,Pitch:0,Yaw:0},d=Array(),l=["","varying   vec4 vTexCoord;","void main(void){","    vTexCoord = vec4(position,1.0);","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);","}",""].join("\n"),u=["","varying vec4 vTexCoord;","uniform bool flipX;","uniform bool flipY;","uniform sampler2D texture;","const float PI = 3.1415926535;","void main(void){","    float pitch = atan(vTexCoord.y, vTexCoord.x);","    float n = length(vTexCoord.xy);","    float roll = atan(n, vTexCoord.z);","    float r = 1.33 * roll / PI;","    float u = r * cos(pitch) + 0.5;","    float v = r * sin(pitch) + 0.5;","    if(r > 0.60 || u < 0.0 || u > 1.0 || v < 0.0 || v > 1.0){","		gl_FragColor = vec4(0.2, 0.2, 0.2, 1.0);","    }","    else{","	    if(flipX){","	    	u = 1.0 - u;","	    }","	    if(flipY){","	    	v = 1.0 - v;","	    }","	    gl_FragColor = texture2D(texture, vec2(u, v));","	}","}",""].join("\n"),E=!1;return{setMyAttitude:function(e){o=e},setVehicleAttitude:function(e){r=e},addFisheyeCamera:function(e,t,n,a,o,r){var E=new THREE.SphereGeometry(500,100,100,0,Math.PI);E.scale(1,1,1);var c=new THREE.TextureLoader,w=c.load(e,function(c){var T=new THREE.ShaderMaterial({vertexShader:l,fragmentShader:u,uniforms:{flipX:{type:"i",value:n},flipY:{type:"i",value:a},texture:{type:"t",value:w}},side:THREE.DoubleSide,blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1});T.needsUpdate=!0;var h=new THREE.Mesh(E,T);i.add(h),d.push({loading:!1,default_image_url:e,imageUrl:t,image_updated_callback:o,mesh:h,attitude:r})})},init:function(o){t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1100),t.position=new THREE.Vector3(0,0,0),t.target=new THREE.Vector3(0,0,-1),t.up=new THREE.Vector3(0,1,0),t.lookAt(t.target),i=new THREE.Scene,n=new THREE.WebGLRenderer({canvas:o,antialias:!0}),n.setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth,window.innerHeight),container.appendChild(n.domElement),a=new THREE.StereoEffect(n),a.setSize(window.innerWidth,window.innerHeight),window.addEventListener("resize",e,!1)},setFov:function(i){t.fov=i,e()},animate:function(){d.forEach(function(e){if(0==e.loading){e.loading=!0;var t=new THREE.TextureLoader,i=t.load(e.imageUrl,function(t){console.log("Drawing image");var i=e.mesh.material.uniforms.texture.value;e.mesh.material.uniforms.texture.value=t,e.mesh.material.needsUpdate=!0,i.dispose(),e.loading=!1});setTimeout(function(){null!=i.image&&i.image.complete&&i.image.naturalWidth||(console.log("timeout"),e.loading=!1)},5e3),e.image_updated_callback&&e.image_updated_callback()}}),this.update()},update:function(){d.forEach(function(e){var t=new THREE.Euler(THREE.Math.degToRad(e.attitude.Roll),THREE.Math.degToRad(e.attitude.Pitch),THREE.Math.degToRad(e.attitude.Yaw));t.order="ZYX";var i=new THREE.Quaternion;i.setFromEuler(t);var n=new THREE.Euler(THREE.Math.degToRad(r.Roll),THREE.Math.degToRad(-r.Pitch),THREE.Math.degToRad(-r.Yaw+180));n.order="ZYX";var a=new THREE.Vector3(0,0,1);e.mesh.up=new THREE.Vector3(0,1,0);var o=new THREE.Quaternion;o.setFromEuler(n),o.multiply(i),a.applyQuaternion(o),e.mesh.up.applyQuaternion(o),e.mesh.lookAt(a)});var e=new THREE.Euler(THREE.Math.degToRad(o.Roll),THREE.Math.degToRad(-o.Pitch),THREE.Math.degToRad(o.Yaw));e.order="ZYX";var l=new THREE.Quaternion;l.setFromEuler(e),t.target=new THREE.Vector3(0,0,-1),t.up=new THREE.Vector3(0,1,0),t.target.applyQuaternion(l),t.up.applyQuaternion(l),t.lookAt(t.target),E?a.render(i,t):n.render(i,t)},setStereoEnabled:function(t){E=t,e()}}}